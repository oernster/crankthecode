<!DOCTYPE html>
<html lang="en" class="theme-dark">
<head>
  <meta charset="utf-8">
  <title>{% if page_title %}{{ page_title }}{% else %}{% block title %}Crank The Code{% endblock %}{% endif %}</title>

  {# Meta description #}
  {% if meta_description %}
    <meta name="description" content="{{ meta_description }}">
  {% elif post %}
    <meta name="description" content="{{ post.blurb or post.one_liner }}">
  {% elif is_homepage %}
    <meta
      name="description"
      content="Python engineering blog by Oliver Ernster. Senior engineer building clean, efficient software‚Äîwriting about Python, systems, FastAPI tooling and ideas that actually ship."
    >
  {% else %}
    <meta
      name="description"
      content="Crank The Code ~ Software projects, tools, hardware and engineering ideas that ship."
    >
  {% endif %}

  
  {% if canonical_url %}
    <link rel="canonical" href="{{ canonical_url | default(request.url) }}">
  {% endif %}

  {# OpenGraph / Twitter (non-visual, improves previews) #}
  {% if og_title %}
    <meta property="og:title" content="{{ og_title }}">
  {% endif %}
  {% if og_description %}
    <meta property="og:description" content="{{ og_description }}">
  {% elif meta_description %}
    <meta property="og:description" content="{{ meta_description }}">
  {% endif %}
  {% if canonical_url %}
    <meta property="og:url" content="{{ canonical_url }}">
  {% endif %}
  <meta property="og:type" content="{{ og_type or 'website' }}">
  <meta property="og:site_name" content="Crank The Code">
  {% if og_image_url %}
    <meta property="og:image" content="{{ og_image_url }}">
  {% endif %}

  <meta name="twitter:card" content="summary_large_image">
  {% if og_title %}
    <meta name="twitter:title" content="{{ og_title }}">
  {% endif %}
  {% if og_description %}
    <meta name="twitter:description" content="{{ og_description }}">
  {% elif meta_description %}
    <meta name="twitter:description" content="{{ meta_description }}">
  {% endif %}
  {% if og_image_url %}
    <meta name="twitter:image" content="{{ og_image_url }}">
  {% endif %}

  {% if robots_meta %}
    <meta name="robots" content="{{ robots_meta }}">
  {% endif %}

  {% if jsonld_json %}
    <script type="application/ld+json">{{ jsonld_json | safe }}</script>
  {% endif %}

  {% if jsonld_extra_json %}
    <script type="application/ld+json">{{ jsonld_extra_json | safe }}</script>
  {% endif %}

  {#
    Theme bootstrap:
    - Avoids a flash of the default theme by applying the preferred theme class
      before CSS loads.
    - Uses localStorage if set; otherwise falls back to OS preference.
  #}
  <script>
    (function () {
      try {
        const root = document.documentElement;
        const savedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        const initialTheme = savedTheme || (prefersDark ? "theme-dark" : "theme-light");
        root.classList.remove("theme-dark", "theme-light");
        root.classList.add(initialTheme);
      } catch (e) {
        // If localStorage is unavailable, keep the default.
      }
    })();
  </script>

  {#
    Contact bootstrap:
    - Centralizes the site email so all pages use the same value and mailto format.
    - Kept in JS (not static HTML) to reduce basic scraping.
  #}
  <script>
    window.CTC_CONTACT = (function () {
      const user = "oernster";
      const domain = "codecrafter.uk";
      const address = user + "@" + domain;
      const link = "mai" + "lto:" + address;
      return { user, domain, address, link };
    })();
  </script>

  <link rel="stylesheet" href="/static/styles.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="alternate" type="application/rss+xml" title="Crank The Code RSS" href="/rss.xml">
</head>
<body{% if is_homepage %} class="is-homepage"{% endif %}>
  <a id="skip-link" class="skip-link" href="#main">Skip to content</a>

  <div class="header-layout{% if back_link_href %} header-layout--has-back{% endif %}">
    <div class="header-gutter header-email" aria-label="Email">
      <script type="text/javascript">
        (function () {
          const c = window.CTC_CONTACT;
          if (!c) {
            return;
          }
          document.write(`<a class="header-email-link" href="${c.link}">${c.address}</a>`);
        })();
      </script>
      <noscript>Email visible with JavaScript enabled ~ or reach me via GitHub.</noscript>
    </div>
    <div class="header-main">
      <div class="header-topbar" aria-label="Header actions">
        <div aria-hidden="true"></div>
        <div class="header-about-wrap">
          <a class="top-about-link" href="/about">About me</a>
          <a class="top-about-link" href="/battlestation">My battlestation</a>
          <a class="top-about-link" href="/help">Help!</a>
        </div>

        <div class="header-actions">
          <button
            id="theme-toggle"
            class="icon-btn theme-toggle"
            type="button"
            aria-label="Toggle dark mode"
            aria-pressed="false"
          >
            <span id="theme-icon" class="fade-icon" aria-hidden="true">üåô</span>
          </button>

          <a class="home-favicon-link" href="/" aria-label="Home">
            <img class="home-favicon-icon" src="/favicon.ico" alt="Crank The Code home" />
          </a>

          <button
            class="icon-btn search-toggle"
            type="button"
            aria-label="Search"
            aria-expanded="false"
            aria-controls="search-panel"
          >
            üîç
          </button>

          <a class="rss-link" href="/rss.xml" aria-label="RSS feed">
            <img class="rss-icon" src="/static/rss.svg" alt="Crank The Code RSS" />
          </a>
        </div>
      </div>

      {% if (breadcrumb_items or []) and not is_homepage %}
        <nav class="breadcrumbs" aria-label="Breadcrumb">
          {% for bc in breadcrumb_items or [] %}
            {% if loop.last %}
              <span class="breadcrumb-current" aria-current="page">{{ bc.label }}</span>
            {% else %}
              <a class="breadcrumb-link" href="{{ bc.href }}">{{ bc.label }}</a>
              <span class="breadcrumb-sep" aria-hidden="true">‚Ä∫</span>
            {% endif %}
          {% endfor %}
        </nav>
      {% endif %}

      <header class="site-header">
        {% if back_link_href %}
          <a class="back-link" href="{{ back_link_href }}">{{ back_link_label or "‚Üê Back" }}</a>
        {% else %}
          <div class="header-spacer" aria-hidden="true"></div>
        {% endif %}

        <a class="site-title-link" href="/" aria-label="Homepage">
          {% if is_homepage %}
            <h1 class="site-title">Crank The Code</h1>
          {% else %}
            <span class="site-title">Crank The Code</span>
          {% endif %}
        </a>

        <div class="header-spacer" aria-hidden="true"></div>
      </header>

      <div class="header-cta" aria-label="Contact call to action">
        <span class="header-cta-slot" aria-label="Email me">
          <a
            id="header-cta-link"
            class="header-cta-link"
            href="/#contact"
          >
            Let‚Äôs build something ~ email me.
          </a>
          <script type="text/javascript">
            // Keep the email address out of the static HTML to reduce bot scraping.
            (function () {
              const c = window.CTC_CONTACT;
              const el = document.getElementById("header-cta-link");
              if (!el || !c) {
                return;
              }
              el.setAttribute("href", c.link);
            })();
          </script>
        </span>
      </div>

      <div id="search-panel" class="search-panel" hidden>
        <label class="visually-hidden" for="site-search">Search posts</label>
        <form class="search-form" role="search" action="/posts" method="get">
          <div class="search-input-wrap">
            <input
              id="site-search"
              class="search-input"
              name="q"
              type="search"
              placeholder="Search posts‚Ä¶"
              autocomplete="on"
              required
            />
            <div id="search-suggestions" class="search-suggestions" hidden></div>
            <button
              class="search-close"
              type="button"
              aria-label="Close search"
              title="Close search"
            >
              ‚úï
            </button>
          </div>
          <button class="search-go" type="submit" aria-label="Search">Go</button>
        </form>
      </div>
    </div>
  </div>

  <div class="page-layout">
    <nav class="sidebar" aria-label="Categories">
      <h2 class="sidebar-title">Categories</h2>
      <a
        class="sidebar-link sidebar-link--all-posts{% if request.url.path == '/posts' and (current_q or '')|length == 0 and exclude_blog %} is-active{% endif %}"
        href="/posts?exclude_blog=1"
      >
        <span class="sidebar-link__icon" aria-hidden="true">üåÄ</span>
        <span class="sidebar-link__text" aria-label="All posts excluding blog posts">
          <span class="sidebar-link__text-main">All posts</span>
          <span class="sidebar-link__text-sub">(exc. Blog)</span>
        </span>
      </a>
      {% for cat in sidebar_categories or [] %}
        <a
          class="sidebar-link{% if (current_q or '')|lower == (cat.query or '')|lower %} is-active{% endif %}"
          href="{{ cat.href }}"
        >
          {{ cat.label }}
        </a>
      {% endfor %}

      <a class="sticky-cta sidebar-sticky-cta" href="/#contact">‚úâ Work With Me</a>
    </nav>

    <main id="main" class="page-main">
      <div class="read-time-bar">
        <small class="read-time" aria-label="Estimated read time" hidden>
          üïí Calculating‚Ä¶
        </small>
      </div>
      {% block content %}{% endblock %}
    </main>
  </div>

  <div class="floating-actions" aria-label="Floating actions">
    <button
      id="scroll-top"
      class="scroll-top"
      type="button"
      aria-label="Scroll to top"
      title="Scroll to top"
      hidden
    >
      ‚¨ÜÔ∏è
    </button>
  </div>

  <script src="/static/search.js" defer></script>
  <script src="/static/scroll-top.js" defer></script>
  <script src="/static/copy-code.js" defer></script>
  <script src="/static/read-time.js" defer></script>

  <script>
    (function () {
      const themeToggle = document.getElementById("theme-toggle");
      const themeIcon = document.getElementById("theme-icon");
      const root = document.documentElement;

      if (!themeToggle || !themeIcon || !root) {
        return;
      }

      const THEMES = {
        DARK: "theme-dark",
        LIGHT: "theme-light",
      };

      function setTheme(theme) {
        root.classList.remove(THEMES.DARK, THEMES.LIGHT);
        root.classList.add(theme);

        // Accessibility: expose the toggle state to assistive tech.
        themeToggle.setAttribute("aria-pressed", theme === THEMES.DARK ? "true" : "false");

        // Icon represents the *target* mode (what will happen if you click).
        // - In dark mode, show sun (switch to light).
        // - In light mode, show moon (switch to dark).
        themeIcon.textContent = theme === THEMES.DARK ? "üåû" : "üåô";

        try {
          localStorage.setItem("theme", theme);
        } catch (e) {
          // Ignore; theme still applies for this session.
        }
      }

      // Sync icon with whatever theme bootstrap selected.
      if (root.classList.contains(THEMES.LIGHT)) {
        themeIcon.textContent = "üåô";
      } else {
        themeIcon.textContent = "üåû";
      }

      // Sync toggle a11y state with the bootstrap-selected theme.
      themeToggle.setAttribute(
        "aria-pressed",
        root.classList.contains(THEMES.DARK) ? "true" : "false"
      );

      themeToggle.addEventListener("click", function () {
        const isDark = root.classList.contains(THEMES.DARK);
        const newTheme = isDark ? THEMES.LIGHT : THEMES.DARK;

        themeIcon.classList.add("fade-out");
        window.setTimeout(function () {
          setTheme(newTheme);
          themeIcon.classList.remove("fade-out");
        }, 150);
      });
    })();
  </script>
</body>
</html>

